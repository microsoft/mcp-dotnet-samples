# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: onedrive-download

metadata:
  template: azd-init@1.14.0

hooks:
  postprovision:
    windows:
      shell: pwsh
      run: |
        dotnet run --project ./src/McpSamples.OnedriveDownload.HybridApp --configuration Release -- --provision

        # Copy refresh token from .env.local to .azure/{env}/.env
        $envLocalPath = "./src/McpSamples.OnedriveDownload.HybridApp/.env.local"
        $envName = $env:AZURE_ENV_NAME
        $azureEnvPath = "./.azure/$envName/.env"

        if (Test-Path $envLocalPath) {
          $refreshToken = (Get-Content $envLocalPath | Select-String "^PERSONAL_365_REFRESH_TOKEN=" | ForEach-Object { $_.Line.Split("=", 2)[1] })
          if ($refreshToken) {
            Write-Host "[INFO] Copying refresh token to $azureEnvPath..."
            # Remove existing PERSONAL_365_REFRESH_TOKEN line if it exists
            $content = Get-Content $azureEnvPath | Where-Object { -not $_.StartsWith("PERSONAL_365_REFRESH_TOKEN=") }
            $content | Set-Content $azureEnvPath
            # Append new token
            Add-Content $azureEnvPath "PERSONAL_365_REFRESH_TOKEN=$refreshToken"
            Write-Host "[OK] Refresh token copied successfully"
          }
        }
    posix:
      shell: sh
      run: |
        dotnet run --project ./src/McpSamples.OnedriveDownload.HybridApp --configuration Release -- --provision

        # Copy refresh token from .env.local to .azure/{env}/.env
        envLocalPath="./src/McpSamples.OnedriveDownload.HybridApp/.env.local"
        envName="$AZURE_ENV_NAME"
        azureEnvPath="./.azure/$envName/.env"

        if [ -f "$envLocalPath" ]; then
          refreshToken=$(grep "^PERSONAL_365_REFRESH_TOKEN=" "$envLocalPath" | cut -d'=' -f2-)
          if [ -n "$refreshToken" ]; then
            echo "[INFO] Copying refresh token to $azureEnvPath..."
            # Remove existing PERSONAL_365_REFRESH_TOKEN line if it exists
            grep -v "^PERSONAL_365_REFRESH_TOKEN=" "$azureEnvPath" > "$azureEnvPath.tmp" && mv "$azureEnvPath.tmp" "$azureEnvPath"
            # Append new token
            echo "PERSONAL_365_REFRESH_TOKEN=$refreshToken" >> "$azureEnvPath"
            echo "[OK] Refresh token copied successfully"
          fi
        fi
  postdeploy:
    windows:
      shell: pwsh
      run: |
        # Read token from .azure/{env}/.env file
        $envFile = ".\.azure\$env:AZURE_ENV_NAME\.env"
        Write-Host "[DEBUG] Looking for .env file at: $envFile"
        Write-Host "[DEBUG] AZURE_ENV_NAME: $env:AZURE_ENV_NAME"
        Write-Host "[DEBUG] AZURE_RESOURCE_MCP_ONEDRIVE_DOWNLOAD_NAME: $env:AZURE_RESOURCE_MCP_ONEDRIVE_DOWNLOAD_NAME"

        if (Test-Path $envFile) {
          Write-Host "[DEBUG] .env file found"
          $content = Get-Content $envFile -Raw -Encoding UTF8
          $refreshToken = $null
          foreach ($line in $content -split "`n") {
            if ($line -match '^PERSONAL_365_REFRESH_TOKEN=(.*)$') {
              $refreshToken = $matches[1].Trim('"').Trim("'")
              Write-Host "[DEBUG] Token extracted, length: $($refreshToken.Length)"
              break
            }
          }

          if ($refreshToken -and $refreshToken.Length -gt 10) {
            $functionAppName = $env:AZURE_RESOURCE_MCP_ONEDRIVE_DOWNLOAD_NAME
            $resourceGroup = "rg-$env:AZURE_ENV_NAME"
            Write-Host "[INFO] Setting refresh token to Azure Function App: $functionAppName"
            Write-Host "[DEBUG] Resource Group: $resourceGroup"

            # Execute the command with proper error handling
            $result = az functionapp config appsettings set --name $functionAppName --resource-group $resourceGroup --settings "PERSONAL_365_REFRESH_TOKEN=$refreshToken" 2>&1
            if ($LASTEXITCODE -eq 0) {
              Write-Host "[OK] Token set successfully: $functionAppName"

              Write-Host "[INFO] Waiting 10 seconds before restarting Function App..."
              Start-Sleep -Seconds 10

              Write-Host "[INFO] Restarting Function App..."
              az functionapp stop --name $functionAppName --resource-group $resourceGroup
              Start-Sleep -Seconds 5
              az functionapp start --name $functionAppName --resource-group $resourceGroup
              Write-Host "[OK] Function App restart completed!"
            } else {
              Write-Host "[ERROR] Failed to set token: $result"
            }
          } else {
            Write-Host "[WARN] PERSONAL_365_REFRESH_TOKEN not found or empty in .env file"
          }
        } else {
          Write-Host "[ERROR] .env file not found: $envFile"
          Write-Host "[DEBUG] Current directory: $(Get-Location)"
          Write-Host "[DEBUG] Contents of .azure directory:"
          Get-ChildItem -Path ".\.azure" -Recurse | Select-Object -Property FullName
        }
    posix:
      shell: sh
      run: |
        # .azure/{env}/.env 파일에서 토큰 읽기
        envFile="./.azure/$AZURE_ENV_NAME/.env"
        if [ -f "$envFile" ]; then
          refreshToken=$(grep '^PERSONAL_365_REFRESH_TOKEN=' "$envFile" | cut -d'=' -f2- | sed 's/^"//;s/"$//')
          if [ -n "$refreshToken" ]; then
            functionAppName="$AZURE_RESOURCE_MCP_ONEDRIVE_DOWNLOAD_NAME"
            resourceGroup="rg-$AZURE_ENV_NAME"
            echo "토큰을 Azure Function App에 설정 중..."
            az functionapp config appsettings set --name "$functionAppName" --resource-group "$resourceGroup" --settings "PERSONAL_365_REFRESH_TOKEN=$refreshToken"
            echo "완료: $functionAppName"
          else
            echo "PERSONAL_365_REFRESH_TOKEN을 찾을 수 없습니다"
          fi
        else
          echo ".env 파일을 찾을 수 없습니다: $envFile"
        fi

services:
  onedrive-download:
    project: src/McpSamples.OnedriveDownload.HybridApp
    host: function
    language: csharp