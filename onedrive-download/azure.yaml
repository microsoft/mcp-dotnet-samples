# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: onedrive-download

metadata:
  template: azd-init@1.14.0

hooks:
  postprovision:
    windows:
      shell: pwsh
      run: dotnet run --project ./src/McpSamples.OnedriveDownload.HybridApp --configuration Release -- --provision
    posix:
      shell: sh
      run: dotnet run --project ./src/McpSamples.OnedriveDownload.HybridApp --configuration Release -- --provision
  postdeploy:
    windows:
      shell: pwsh
      run: |
        # Read token from .azure/{env}/.env file
        $envFile = ".\.azure\$env:AZURE_ENV_NAME\.env"
        if (Test-Path $envFile) {
          $content = Get-Content $envFile -Raw -Encoding UTF8
          $refreshToken = $null
          foreach ($line in $content -split "`n") {
            if ($line -match '^PERSONAL_365_REFRESH_TOKEN=(.*)$') {
              $refreshToken = $matches[1].Trim('"')
              break
            }
          }

          if ($refreshToken) {
            $functionAppName = $env:AZURE_RESOURCE_MCP_ONEDRIVE_DOWNLOAD_NAME
            $resourceGroup = "rg-$env:AZURE_ENV_NAME"
            Write-Host "[INFO] Setting refresh token to Azure Function App..."
            az functionapp config appsettings set --name $functionAppName --resource-group $resourceGroup --settings "PERSONAL_365_REFRESH_TOKEN=$refreshToken" | Out-Null
            Write-Host "[OK] Token set successfully: $functionAppName"

            Write-Host "[INFO] Restarting Function App..."
            az functionapp restart --name $functionAppName --resource-group $resourceGroup
            Write-Host "[OK] Function App restart completed!"
          } else {
            Write-Host "[WARN] PERSONAL_365_REFRESH_TOKEN not found in .env file"
          }
        } else {
          Write-Host "[ERROR] .env file not found: $envFile"
        }
    posix:
      shell: sh
      run: |
        # .azure/{env}/.env 파일에서 토큰 읽기
        envFile="./.azure/$AZURE_ENV_NAME/.env"
        if [ -f "$envFile" ]; then
          refreshToken=$(grep '^PERSONAL_365_REFRESH_TOKEN=' "$envFile" | cut -d'=' -f2- | sed 's/^"//;s/"$//')
          if [ -n "$refreshToken" ]; then
            functionAppName="$AZURE_RESOURCE_MCP_ONEDRIVE_DOWNLOAD_NAME"
            resourceGroup="rg-$AZURE_ENV_NAME"
            echo "토큰을 Azure Function App에 설정 중..."
            az functionapp config appsettings set --name "$functionAppName" --resource-group "$resourceGroup" --settings "PERSONAL_365_REFRESH_TOKEN=$refreshToken"
            echo "완료: $functionAppName"
          else
            echo "PERSONAL_365_REFRESH_TOKEN을 찾을 수 없습니다"
          fi
        else
          echo ".env 파일을 찾을 수 없습니다: $envFile"
        fi

services:
  onedrive-download:
    project: src/McpSamples.OnedriveDownload.HybridApp
    host: function
    language: csharp