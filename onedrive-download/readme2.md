# MCP OneDrive Download Server - ìƒì„¸ ë¶„ì„ ê°€ì´ë“œ

## ëª©ì°¨
1. [ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜](#ì‹œìŠ¤í…œ-ì•„í‚¤í…ì²˜)
2. [ì½”ë“œ ì—­í•  ë¶„ì„](#ì½”ë“œ-ì—­í• -ë¶„ì„)
3. [í˜„ì¬ ì—ëŸ¬ ë¶„ì„](#í˜„ì¬-ì—ëŸ¬-ë¶„ì„spo-ë¼ì´ì„ ìŠ¤-ì˜¤ë¥˜)
4. [ì‚¬ìš©ì íë¦„](#ì‚¬ìš©ì-íë¦„)
5. [OAuth 2.0 ì¸ì¦ íë¦„](#oauth-20-ì¸ì¦-íë¦„)

---

## ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### ê°œìš”
ì´ MCP(Model Context Protocol) ì„œë²„ëŠ” Azure Functionsì—ì„œ ì‹¤í–‰ë˜ëŠ” OneDrive íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ì‚¬ìš©ì (User)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ 1. ë¡œê·¸ì¸ ìš”ì²­ + OneDrive URL
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         MCP Server (Azure Functions HTTP)                    â”‚
â”‚         - Program.cs: ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”                   â”‚
â”‚         - Controllers: HTTP ìš”ì²­ ì²˜ë¦¬                       â”‚
â”‚         - Services: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§                           â”‚
â”‚         - Tools: MCP ë„êµ¬ êµ¬í˜„                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                 â”‚
        â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Microsoft Entra   â”‚          â”‚ OneDrive/SharePoint  â”‚
â”‚  - OAuth ì¸ì¦      â”‚          â”‚ - íŒŒì¼ ë‹¤ìš´ë¡œë“œ      â”‚
â”‚  - í† í° ê´€ë¦¬       â”‚          â”‚ - ì‚¬ìš©ì ê¶Œí•œ í™•ì¸   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TokenStorage       â”‚
â”‚ (In-Memory Cache)  â”‚
â”‚ - Access Token     â”‚
â”‚ - Refresh Token    â”‚
â”‚ - ë§Œë£Œ ì‹œê°„        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ì½”ë“œ ì—­í•  ë¶„ì„

### 1. **Program.cs** - ì• í”Œë¦¬ì¼€ì´ì…˜ ì§„ì…ì 
**ìœ„ì¹˜**: `src/McpSamples.OnedriveDownload.HybridApp/Program.cs`

**ì—­í• **:
- ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ë° ì˜ì¡´ì„± ì£¼ì… ì„¤ì •
- HTTP/stdio ëª¨ë“œ ì„ íƒ (ê¸°ë³¸ê°’: HTTP)
- Azure Key Vault ë¡œë“œ
- Application Insights ì„¤ì •
- ì„¸ì…˜ ë¯¸ë“¤ì›¨ì–´ ë“±ë¡
- OpenAPI (Swagger) ë¬¸ì„œ ìƒì„±

**í•µì‹¬ ì½”ë“œ**:
```csharp
// 1. HTTP ëª¨ë“œ ê°•ì œ (--stdio ëª…ì‹œ ì‹œì—ë§Œ stdio ëª¨ë“œ)
if (!args.Contains("--stdio", StringComparer.InvariantCultureIgnoreCase))
{
    useStreamableHttp = true;
}

// 2. ì„¸ì…˜ ì„œë¹„ìŠ¤ ë“±ë¡ (ì‚¬ìš©ì í† í° ì €ì¥ì†Œìš©)
builder.Services.AddSession(options =>
{
    options.IdleTimeout = TimeSpan.FromHours(1);
    options.Cookie.HttpOnly = true;
});

// 3. ì„¤ì • ë¡œë“œ
builder.Services.AddAppSettings<OnedriveDownloadAppSettings>(builder.Configuration, args);

// 4. ë¡œê¹…: ì„¤ì • ê°’ í™•ì¸
logger.LogInformation("*** [Config] TenantId: {TenantId}",
    builder.Configuration["OnedriveDownload:EntraId:TenantId"]);
```

### 2. **UserAuthenticationService.cs** - OAuth ì¸ì¦ ì²˜ë¦¬
**ìœ„ì¹˜**: `src/McpSamples.OnedriveDownload.HybridApp/Services/UserAuthenticationService.cs`

**ì—­í• **:
- OAuth 2.0 Authorization Code Flow êµ¬í˜„
- ì¸ì¦ URL ìƒì„± (Microsoft ë¡œê·¸ì¸ í˜ì´ì§€)
- ì¸ì¦ ì½”ë“œë¥¼ ì•¡ì„¸ìŠ¤ í† í°ìœ¼ë¡œ êµí™˜
- GraphServiceClient ìƒì„± ë° ê´€ë¦¬
- í† í° ê°±ì‹  ê´€ë¦¬

**ì£¼ìš” ë©”ì„œë“œ**:
```csharp
// 1. ë¡œê·¸ì¸ URL ìƒì„±
string GetAuthorizationUrl()
// â†’ https://login.microsoftonline.com/{TenantId}/oauth2/v2.0/authorize?...

// 2. ì¸ì¦ ì½”ë“œë¥¼ í† í°ìœ¼ë¡œ êµí™˜
Task<string?> GetAccessTokenFromCodeAsync(string authorizationCode)
// â†’ MSALì„ ì´ìš©í•˜ì—¬ í† í° íšë“
// â†’ TokenStorageì— ì €ì¥

// 3. ì‚¬ìš©ì í† í°ìœ¼ë¡œ GraphServiceClient ìƒì„±
Task<GraphServiceClient> GetUserGraphClientAsync(string userId)
// â†’ TokenStorageì—ì„œ í† í° ì¡°íšŒ
// â†’ í† í° ë§Œë£Œ ì‹œ ê°±ì‹  ì‹œë„
// â†’ DelegateAuthenticationProviderë¡œ í´ë¼ì´ì–¸íŠ¸ ìƒì„±

// 4. í† í° ê°±ì‹  (í˜„ì¬ëŠ” ì¬ì¸ì¦ í•„ìš”)
Task<bool> RefreshAccessTokenAsync(string userId)
// â†’ êµ¬í˜„: ì‚¬ìš©ì ì¬ì¸ì¦ í•„ìš” (refresh token ë¯¸ì‚¬ìš©)
```

### 3. **TokenStorage.cs** - í† í° ìºì‹œ ê´€ë¦¬
**ìœ„ì¹˜**: `src/McpSamples.OnedriveDownload.HybridApp/Services/TokenStorage.cs`

**ì—­í• **:
- ì‚¬ìš©ì OAuth í† í° ì €ì¥ì†Œ (In-Memory)
- í† í° ë§Œë£Œ ì‹œê°„ ê´€ë¦¬
- í˜„ì¬ ì‚¬ìš©ì ID ì¶”ì 

**êµ¬ì¡°**:
```csharp
InMemoryTokenStorage
â”œâ”€â”€ ConcurrentDictionary<userId, TokenInfo>
â”‚   â””â”€â”€ TokenInfo
â”‚       â”œâ”€â”€ AccessToken: string
â”‚       â”œâ”€â”€ RefreshToken: string (í˜„ì¬ ë¯¸ì‚¬ìš©)
â”‚       â””â”€â”€ ExpiresAt: DateTime
â””â”€â”€ CurrentUserId: string

ë©”ì„œë“œ:
â”œâ”€â”€ GetAccessTokenAsync(userId) â†’ í† í° ì¡°íšŒ ë° ë§Œë£Œ í™•ì¸
â”œâ”€â”€ SaveTokenAsync(userId, token, expiresInSeconds) â†’ í† í° ì €ì¥
â”œâ”€â”€ IsTokenExpiredAsync(userId) â†’ ë§Œë£Œ ì—¬ë¶€ í™•ì¸
â”œâ”€â”€ RemoveTokenAsync(userId) â†’ ë¡œê·¸ì•„ì›ƒ (í† í° ì‚­ì œ)
â”œâ”€â”€ GetCurrentUserIdAsync() / SetCurrentUserIdAsync() â†’ í˜„ì¬ ì‚¬ìš©ì ê´€ë¦¬
â””â”€â”€ RefreshToken ë©”ì„œë“œ (ì•„ì§ êµ¬í˜„ë˜ì§€ ì•ŠìŒ)
```

**âš ï¸ ì£¼ì˜**:
- In-Memory ì €ì¥ì†Œì´ë¯€ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘ ì‹œ í† í° ì†ì‹¤
- í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” Redisë‚˜ Azure Cosmos DB ê¶Œì¥

### 4. **OneDriveTool.cs** - íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë„êµ¬
**ìœ„ì¹˜**: `src/McpSamples.OnedriveDownload.HybridApp/Tools/OneDriveTool.cs`

**ì—­í• **:
- MCP ì„œë²„ ë„êµ¬ë¡œ OneDrive íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì œê³µ
- ê³µìœ  URL ê²€ì¦
- HTTPë¥¼ í†µí•œ ì§ì ‘ ë‹¤ìš´ë¡œë“œ
- Azure File Shareì— ì—…ë¡œë“œ

**MCP ë„êµ¬ ì •ì˜**:
```csharp
[McpServerTool(
    Name = "download_file_from_onedrive_url",
    Title = "Download File from OneDrive URL"
)]
public async Task<OneDriveDownloadResult> DownloadFileFromUrlAsync(
    string sharingUrl)
```

**ì‘ë™ íë¦„**:
```
1. URL ê²€ì¦
   â”œâ”€â”€ ìœ íš¨í•œ URI í˜•ì‹ í™•ì¸
   â””â”€â”€ ë„ë©”ì¸ í™•ì¸: 1drv.ms, onedrive.live.com, sharepoint.com

2. HTTP ë‹¤ìš´ë¡œë“œ (ì‚¬ìš©ì í† í° ë¯¸ì‚¬ìš©)
   â”œâ”€â”€ HttpClientë¡œ ê³µìœ  ë§í¬ì—ì„œ ì§ì ‘ ë‹¤ìš´ë¡œë“œ
   â”œâ”€â”€ User-Agent í—¤ë” ì¶”ê°€ (Mozilla/5.0)
   â””â”€â”€ ì„±ê³µ í™•ì¸ (HTTP 200)

3. íŒŒì¼ëª… ì¶”ì¶œ
   â”œâ”€â”€ Content-Disposition í—¤ë”ì—ì„œ ì¶”ì¶œ
   â””â”€â”€ URL ê²½ë¡œì—ì„œ ì¶”ì¶œ (ì‹¤íŒ¨ ì‹œ)

4. Azure File Share ì—…ë¡œë“œ
   â”œâ”€â”€ File Share í´ë¼ì´ì–¸íŠ¸ ìƒì„±
   â”œâ”€â”€ /downloads ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ì„ ê²½ìš°)
   â””â”€â”€ íŒŒì¼ ì—…ë¡œë“œ

5. ê²°ê³¼ ë°˜í™˜
   â”œâ”€â”€ DownloadPath: File Share ê²½ë¡œ
   â”œâ”€â”€ FileName: ë‹¤ìš´ë¡œë“œ íŒŒì¼ëª…
   â””â”€â”€ ErrorMessage: ì—ëŸ¬ ë©”ì‹œì§€ (ì‹¤íŒ¨ ì‹œ)
```

### 5. **Configuration ë° ì„¤ì •**
**OnedriveDownloadAppSettings.cs**:
```csharp
EntraIdSettings
â”œâ”€â”€ TenantId: Azure í…Œë„ŒíŠ¸ ID
â”œâ”€â”€ ClientId: ì•± í´ë¼ì´ì–¸íŠ¸ ID
â”œâ”€â”€ ClientSecret: ì•± í´ë¼ì´ì–¸íŠ¸ ë¹„ë°€
â”œâ”€â”€ UserAssignedClientId: ì‚¬ìš©ì í• ë‹¹ ê´€ë¦¬ ID
â””â”€â”€ UseManagedIdentity: ê´€ë¦¬ ID ì‚¬ìš© ì—¬ë¶€
```

---

## í˜„ì¬ ì—ëŸ¬ ë¶„ì„: SPO ë¼ì´ì„ ìŠ¤ ì˜¤ë¥˜

### ì—ëŸ¬ ë©”ì‹œì§€
```json
{
  "errorMessage": "OneDrive API error: Code: BadRequest\nMessage: Tenant does not have a SPO license.\n..."
}
```

### âœ… **ì´ ì—ëŸ¬ì˜ ì •ì²´ì™€ í•´ê²° ë°©ì•ˆ**

#### 1ï¸âƒ£ **ì—ëŸ¬ ì›ì¸ ë¶„ì„**

**ì—ëŸ¬ì˜ ê·¼ì›**:
- Microsoft Graph APIë¥¼ í†µí•´ `/me/drive` ì—”ë“œí¬ì¸íŠ¸ì— ì ‘ê·¼í•  ë•Œ ë°œìƒ
- **ê´€ë¦¬ìê°€ ì•±ì— "Files.Read.All" ë˜ëŠ” "Files.ReadWrite.All" ê¶Œí•œì„ í• ë‹¹í–ˆì§€ë§Œ, í…Œë„ŒíŠ¸ì— SPO ë¼ì´ì„ ìŠ¤ê°€ ì—†ëŠ” ê²½ìš°**

**ì–¸ì œ ë°œìƒí•˜ëŠ”ê°€?**:
```csharp
// âŒ ì´ë ‡ê²Œ í•˜ë©´ ì—ëŸ¬ ë°œìƒ:
var graphClient = await userAuthService.GetUserGraphClientAsync(userId);
var driveItems = await graphClient.Me.Drive.Root.Children.GetAsync();
// â†’ "Tenant does not have a SPO license" ì—ëŸ¬

// ë˜ëŠ” ë§ˆì°¬ê°€ì§€ë¡œ:
var files = await graphClient.Me.Drive.Items.GetAsync();
```

**ì™œ ë°œìƒí•˜ëŠ”ê°€?**:
1. Entra ID ì•±ì— ê³ ê¸‰ Graph ê¶Œí•œ(Files.* ê¶Œí•œ)ì´ ì„¤ì •ë¨
2. í…Œë„ŒíŠ¸ì— SharePoint Online (SPO) ë¼ì´ì„ ìŠ¤ê°€ ì—†ìŒ
3. Graph APIëŠ” ê³ ê¸‰ ê¶Œí•œ ì‚¬ìš© ì‹œ SPO ë¼ì´ì„ ìŠ¤ í™•ì¸
4. ë¼ì´ì„ ìŠ¤ ì—†ìœ¼ë©´ BadRequest ë°˜í™˜

#### 2ï¸âƒ£ **í˜„ì¬ ì½”ë“œ êµ¬ì¡°ì˜ ë¬¸ì œì **

í˜„ì¬ OneDriveToolì€ **HTTP ì§ì ‘ ë‹¤ìš´ë¡œë“œë¥¼ ì‚¬ìš©**í•˜ë¯€ë¡œ:
```csharp
// âœ… HTTP ì§ì ‘ ë‹¤ìš´ë¡œë“œ (ë¬¸ì œ ì—†ìŒ)
using var httpClient = new System.Net.Http.HttpClient();
var response = await httpClient.GetAsync(sharingUrl);
// â†’ SPO ë¼ì´ì„ ìŠ¤ ë¶ˆí•„ìš”
// â†’ Graph API ê¶Œí•œ ë¶ˆí•„ìš”
// â†’ ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•ŠìŒ
```

**í•˜ì§€ë§Œ**:
- OAuth ì¸ì¦ ê¸°ëŠ¥ì´ êµ¬í˜„ë˜ì–´ ìˆëŠ”ë° **ì‚¬ìš©ë˜ì§€ ì•ŠìŒ**
- UserAuthenticationServiceëŠ” ì™„ì „íˆ êµ¬í˜„ë˜ì–´ ìˆìŒ
- GetUserGraphClientAsync() ë©”ì„œë“œë„ ìˆìŒ
- **í† í° ì €ì¥/ê´€ë¦¬ë„ ì™„ë²½í•œë° í™œìš© ì•ˆ í•¨**

#### 3ï¸âƒ£ **ì˜¬ë°”ë¥¸ í•´ê²° ë°©ì•ˆ (ê¶Œì¥)**

**ë°©ì•ˆ 1: HTTP ì§ì ‘ ë‹¤ìš´ë¡œë“œ (í˜„ì¬ ì½”ë“œ)**
```csharp
// ì¥ì : SPO ë¼ì´ì„ ìŠ¤ ë¶ˆí•„ìš”, ê°„ë‹¨í•¨
// ë‹¨ì : ê³µê°œ/ê³µìœ  ë§í¬ í•„ìš”, Graph API í™œìš© ë¶ˆê°€

// ì´ ê²½ìš° ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•ŠìŒ
```

**ë°©ì•ˆ 2: OAuth ì‚¬ìš©ì ìœ„ì„ ë‹¤ìš´ë¡œë“œ (ê¶Œì¥ ê°œì„ )**
```csharp
// âœ… ì‚¬ìš©ìì˜ ê¶Œí•œìœ¼ë¡œ ì ‘ê·¼
var graphClient = await userAuthService.GetUserGraphClientAsync(userId);

// ë°©ë²• 1: ê³µìœ  URLì„ itemIdë¡œ ë³€í™˜
var driveItem = await graphClient
    .Me.Drive.Items[itemId]
    .Content
    .GetAsync();

// ë˜ëŠ” ë°©ë²• 2: ì‚¬ìš©ì OneDrive ë‚´ íŒŒì¼ ì§ì ‘ ì ‘ê·¼
var userFiles = await graphClient.Me.Drive.Root.Children.GetAsync();

// ì¥ì :
// âœ“ ì‚¬ìš©ìì˜ ê¶Œí•œìœ¼ë¡œ ì œí•œëœ íŒŒì¼ë„ ì ‘ê·¼ ê°€ëŠ¥
// âœ“ ê³µìœ  ë§í¬ ì—†ì–´ë„ ë¨
// âœ“ ì‚¬ìš©ì OneDrive ë‚´ ëª¨ë“  íŒŒì¼ ì ‘ê·¼ ê°€ëŠ¥
// âœ“ ìƒì„¸í•œ ë©”íƒ€ë°ì´í„° íšë“ ê°€ëŠ¥

// ë‹¨ì :
// âœ— SPO ë¼ì´ì„ ìŠ¤ í•„ìˆ˜ (ì´ë¯¸ ê³ ê¸‰ ê¶Œí•œ ì„¤ì •í–ˆìœ¼ë©´)
// âœ— ì‚¬ìš©ì ì¸ì¦ í•„ìˆ˜
```

**ë°©ì•ˆ 3: ê´€ë¦¬ì ìœ„ì„ ë‹¤ìš´ë¡œë“œ (í˜„ì¬ ì„¤ì •í•œ ê²ƒ ê°™ìŒ)**
```csharp
// âŒ í˜„ì¬ ì—ëŸ¬ ë°œìƒ ìƒí™©
// Program.csì—ì„œ ì´ˆê¸°í™”í•œ ê¸°ë³¸ GraphServiceClientê°€ ìˆì„ ìˆ˜ ìˆìŒ
// ì´ê²ƒì´ ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì´ˆê¸°í™”ë˜ë©´ì„œ SPO ë¼ì´ì„ ìŠ¤ ê²€ì‚¬

// í•´ê²°: ê¸°ë³¸ GraphServiceClient ì œê±° ë˜ëŠ” ìµœì†Œ ê¶Œí•œë§Œ ì‚¬ìš©
```

#### 4ï¸âƒ£ **ì–´ë””ì„œ ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ”ê°€?**

Git ì»¤ë°‹ íˆìŠ¤í† ë¦¬ì—ì„œ:
```
bbe25e7 fix #111: GraphServiceClient ì„¤ì • ë¡œë”© ë¬¸ì œ í•´ê²° ë°
        Azure Functions HTTPS ë¦¬ë‹¤ì´ë ‰ì…˜ ë¹„í™œì„±í™”
```

ì´ ì»¤ë°‹ì´ ì‹œì‚¬í•˜ëŠ” ë°”:
- GraphServiceClient ì„¤ì •ì— ë¬¸ì œê°€ ìˆì—ˆìŒ
- ì–´ë”˜ê°€ì—ì„œ ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ GraphServiceClientë¥¼ ì´ˆê¸°í™”í•˜ê³  ìˆì—ˆì„ ìˆ˜ ìˆìŒ
- í˜„ì¬ë„ ê·¸ ë¬¸ì œê°€ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆìŒ

**í™•ì¸í•  ìœ„ì¹˜**:
1. Program.csì—ì„œ GraphServiceClient ë“±ë¡ ë¶€ë¶„
2. OneDriveToolì—ì„œ GraphServiceClient ì‚¬ìš© ë¶€ë¶„ (í˜„ì¬ëŠ” ë¯¸ì‚¬ìš©)
3. ê¸°ë³¸ GraphServiceClient ì´ˆê¸°í™” ë¡œì§

---

## ì‚¬ìš©ì íë¦„ (OAuth ì¸ì¦ ê¸°ë°˜ ê¶Œì¥ ë°©ì‹)

### ğŸ“Š ì „ì²´ ì‚¬ìš©ì íë¦„ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ì‚¬ìš©ì (Claude)                          â”‚
â”‚                                                              â”‚
â”‚  Step 1: "OneDrive íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•´ì¤„ ìˆ˜ ìˆì–´?"           â”‚
â”‚  Step 2: [ë¡œê·¸ì¸ ë§í¬ ì œê³µ] â†’ ì‚¬ìš©ì OAuth ì¸ì¦             â”‚
â”‚  Step 3: "ì´ì œ onedrive.com/items/... ë‹¤ìš´ë¡œë“œí•´ì¤˜"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MCP Server - Authentication Flow               â”‚
â”‚  1. UserAuthenticationService.GetAuthorizationUrl()         â”‚
â”‚  2. ì‚¬ìš©ì ë¦¬ë‹¤ì´ë ‰íŠ¸ â†’ Microsoft OAuth                     â”‚
â”‚  3. ì¸ì¦ ì™„ë£Œ â†’ Redirect URIë¡œ ì½”ë“œ ë°˜í™˜                   â”‚
â”‚  4. UserAuthenticationService.GetAccessTokenFromCodeAsync() â”‚
â”‚  5. TokenStorageì— í† í° ì €ì¥                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ ì¸ì¦ ì™„ë£Œ
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         MCP Server - OneDriveTool (ì‚¬ìš©ì ìœ„ì„ ë°©ì‹)        â”‚
â”‚         2. DownloadFileFromUserAsync í˜¸ì¶œ (ìƒˆë¡œìš´ ë°©ì‹)    â”‚
â”‚                 ë˜ëŠ” ê°œì„ ëœ DownloadFileFromUrlAsync        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”œâ”€ 3. í˜„ì¬ ì‚¬ìš©ì ID ì¡°íšŒ
                   â”‚  â””â”€ TokenStorage.GetCurrentUserIdAsync()
                   â”‚
                   â”œâ”€ 4. ì‚¬ìš©ì GraphServiceClient ìƒì„±
                   â”‚  â””â”€ UserAuthenticationService.GetUserGraphClientAsync(userId)
                   â”‚
                   â”œâ”€ 5. íŒŒì¼ ì ‘ê·¼ ë° ë‹¤ìš´ë¡œë“œ
                   â”‚  â”œâ”€ ê³µìœ  URL ì²˜ë¦¬: ê¶Œí•œ í™•ì¸
                   â”‚  â”œâ”€ ê°œì¸ íŒŒì¼ ì ‘ê·¼: ì‚¬ìš©ì ê¶Œí•œ ì‚¬ìš©
                   â”‚  â””â”€ graphClient.Me.Drive.Items[id].Content.GetAsync()
                   â”‚
                   â”œâ”€ 6. íŒŒì¼ëª… ì¶”ì¶œ
                   â”‚  â””â”€ driveItem.Name ë˜ëŠ” Content-Disposition
                   â”‚
                   â”œâ”€ 7. Azure File Share ì—…ë¡œë“œ
                   â”‚  â””â”€ ShareClient.UploadAsync()
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  OneDriveDownloadResult          â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ âœ… Success Case:                 â”‚
        â”‚  - DownloadPath                  â”‚
        â”‚  - FileName                      â”‚
        â”‚  - ErrorMessage: null            â”‚
        â”‚                                  â”‚
        â”‚ âŒ Failure Case:                 â”‚
        â”‚  - DownloadPath: null            â”‚
        â”‚  - FileName: null                â”‚
        â”‚  - ErrorMessage: string          â”‚
        â”‚    (SPO ë¼ì´ì„ ìŠ¤ í•„ìš”í•œ ê²½ìš° ëª…ì‹œ)
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  ì‚¬ìš©ìì—ê²Œ ê²°ê³¼ ë°˜í™˜             â”‚
        â”‚  - íŒŒì¼ ì €ì¥ ìœ„ì¹˜                 â”‚
        â”‚  - ì˜¤ë¥˜ ë©”ì‹œì§€ ë˜ëŠ” ì„±ê³µ ë©”ì‹œì§€  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1ï¸âƒ£ **ë‹¨ê³„ 1: ì‚¬ìš©ì ì¸ì¦ (OAuth)**

```
ì‚¬ìš©ì: "OneDrive íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•´ì¤„ ìˆ˜ ìˆì–´?"
MCP Server: "ë¨¼ì € ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤: [URLë¡œ ì´ë™]"

ì‚¬ìš©ìê°€ URL í´ë¦­ â†’ Microsoft OAuth ë¡œê·¸ì¸ â†’ ì¸ì¦ ì™„ë£Œ
```

**ì½”ë“œ**:
```csharp
string authUrl = userAuthService.GetAuthorizationUrl();
// â†’ https://login.microsoftonline.com/{TenantId}/oauth2/v2.0/authorize?...
```

### 2ï¸âƒ£ **ë‹¨ê³„ 2: ì¸ì¦ ì½”ë“œ ì²˜ë¦¬ ë° í† í° ì €ì¥**

```
ì¸ì¦ ì™„ë£Œ í›„ Redirect URIë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸:
https://func-onedrive-download.azurewebsites.net/auth/callback?code=M.R3_BAY...
```

**ì½”ë“œ**:
```csharp
string userId = await userAuthService.GetAccessTokenFromCodeAsync(authorizationCode);
// â†’ tokenStorageì— ìë™ ì €ì¥
// â†’ userId ë°˜í™˜ ("user@contoso.com" ë˜ëŠ” principal ID)

await tokenStorage.SetCurrentUserIdAsync(userId);
// â†’ í˜„ì¬ ì‚¬ìš©ì ì„¤ì •
```

### 3ï¸âƒ£ **ë‹¨ê³„ 3: íŒŒì¼ ë‹¤ìš´ë¡œë“œ ìš”ì²­**

```
ì‚¬ìš©ì: "ì´ì œ onedrive.com/items/ABC123/... íŒŒì¼ ë‹¤ìš´ë¡œë“œí•´ì¤˜"
ë˜ëŠ”
ì‚¬ìš©ì: "ë‚´ OneDriveì˜ documents í´ë”ì—ì„œ report.pdf ë‹¤ìš´ë¡œë“œí•´ì¤˜"
```

**ì½”ë“œ**:
```csharp
var result = await oneDriveTool.DownloadFileFromUrlAsync(
    sharingUrlOrFilePath
);
```

### 4ï¸âƒ£ **ë‹¨ê³„ 4: í˜„ì¬ ì‚¬ìš©ì ë° GraphServiceClient í™•ì¸**

```csharp
// OneDriveTool ë‚´ë¶€ì—ì„œ:
string userId = await tokenStorage.GetCurrentUserIdAsync();
// â†’ "user@contoso.com"

if (string.IsNullOrEmpty(userId))
{
    // âŒ ì¸ì¦ í•„ìš”
    return new OneDriveDownloadResult
    {
        ErrorMessage = "User not authenticated. Please login first."
    };
}

var graphClient = await userAuthService.GetUserGraphClientAsync(userId);
// â†’ ì‚¬ìš©ìì˜ OAuth í† í°ìœ¼ë¡œ GraphServiceClient ìƒì„±
// â†’ Bearer token ìë™ ì¶”ê°€
```

### 5ï¸âƒ£ **ë‹¨ê³„ 5: íŒŒì¼ ì ‘ê·¼ ë° ë‹¤ìš´ë¡œë“œ (Graph API)**

**ë°©ë²• A: ê³µìœ  URLì—ì„œ íŒŒì¼ ì ‘ê·¼**
```csharp
// ê³µìœ  URLì„ itemIdë¡œ ë³€í™˜ (í•„ìš”ì‹œ)
// https://onedrive.live.com/embed?resid=ABC123 â†’ itemId = "ABC123"

var driveItem = await graphClient
    .Me.Drive.Items[itemId]
    .Content
    .GetAsync();

// ë˜ëŠ” ê²½ë¡œë¡œ ì§ì ‘ ì ‘ê·¼:
var driveItem = await graphClient
    .Me.Drive.Root.ItemWithPath("Documents/report.pdf")
    .Content
    .GetAsync();

// ì¥ì :
// âœ“ ì‚¬ìš©ìì˜ ê¶Œí•œìœ¼ë¡œ íŒŒì¼ ì ‘ê·¼
// âœ“ ê°œì¸ íŒŒì¼ë„ ì ‘ê·¼ ê°€ëŠ¥
// âœ“ ê³µìœ  ë§í¬ ë¶ˆí•„ìš”
```

**ë°©ë²• B: HTTP ë‹¤ìš´ë¡œë“œ (ë³´ì•ˆìš©)**
```csharp
// ì—¬ì „íˆ HTTP ì§ì ‘ ë‹¤ìš´ë¡œë“œë„ ê°€ëŠ¥ (fallback)
using var httpClient = new System.Net.Http.HttpClient();
var response = await httpClient.GetAsync(sharingUrl);

// í•˜ì§€ë§Œ ì´ ê²½ìš° ì‚¬ìš©ì ì¸ì¦ì´ ë¶ˆí•„ìš”í•¨
// (ê³µê°œ/ê³µìœ  ë§í¬ì—ì„œ ì§ì ‘ ë‹¤ìš´ë¡œë“œ)
```

### 6ï¸âƒ£ **ë‹¨ê³„ 6: íŒŒì¼ëª… ì¶”ì¶œ**

```csharp
// Graph API ì‚¬ìš© ì‹œ (ë©”íƒ€ë°ì´í„° í¬í•¨)
string fileName = driveItem.Name;  // "report.pdf"
long fileSize = driveItem.Size ?? 0;
DateTime? createdTime = driveItem.CreatedDateTime;

// HTTP ë‹¤ìš´ë¡œë“œ ì‹œ
string fileName = ExtractFileName(response, uri);
```

### 7ï¸âƒ£ **ë‹¨ê³„ 7: Azure File Share ì—…ë¡œë“œ**

```csharp
var shareClient = new ShareClient(
    connectionString,
    fileShareName: "downloads"
);
await shareClient.CreateIfNotExistsAsync();

var fileClient = shareClient.GetRootDirectoryClient()
                           .GetFileClient(fileName);

using var contentStream = await response.Content.ReadAsStreamAsync();
await fileClient.UploadAsync(contentStream);

result.FileName = fileName;
result.DownloadPath = fileClient.Path;
```

### 8ï¸âƒ£ **ë‹¨ê³„ 8: ê²°ê³¼ ë°˜í™˜**

```json
// âœ… ì„±ê³µ
{
  "DownloadPath": "downloads/report.pdf",
  "FileName": "report.pdf",
  "ErrorMessage": null
}

// âŒ SPO ë¼ì´ì„ ìŠ¤ ì—†ìŒ
{
  "DownloadPath": null,
  "FileName": null,
  "ErrorMessage": "Tenant does not have a SPO license. Please acquire SharePoint Online license or use public sharing links."
}

// âŒ ì¸ì¦ í•„ìš”
{
  "DownloadPath": null,
  "FileName": null,
  "ErrorMessage": "User not authenticated. Please login first."
}

// âŒ ê¶Œí•œ ì—†ìŒ
{
  "DownloadPath": null,
  "FileName": null,
  "ErrorMessage": "Access denied: You don't have permission to access this file."
}
```

---

## OAuth 2.0 ì¸ì¦ íë¦„

### ğŸ“‹ OAuth 2.0 Authorization Code Flow (ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ìš©)

**ì‚¬ìš© ì´ìœ **:
- ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©ìë¥¼ ëŒ€ì‹ í•˜ì—¬ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼
- ì‚¬ìš©ì ìê²©ì¦ëª…ì„ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë³´ìœ í•˜ì§€ ì•ŠìŒ
- í† í° ë§Œë£Œ ë° ê°±ì‹  ì§€ì›

### ğŸ”„ ì¸ì¦ íë¦„ ìƒì„¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  Step 1: ì‚¬ìš©ì ë¡œê·¸ì¸ ìš”ì²­                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  ì‚¬ìš©ì: "ë¡œê·¸ì¸í•´ì¤˜"                                           â”‚
â”‚                                                                 â”‚
â”‚  MCP Server ì‘ë‹µ:                                              â”‚
â”‚  GET https://login.microsoftonline.com/{TenantId}/oauth2/v2.0/ â”‚
â”‚      authorize?client_id={ClientId}                             â”‚
â”‚                &redirect_uri={RedirectUri}                      â”‚
â”‚                &response_type=code                              â”‚
â”‚                &scope=https://graph.microsoft.com/.default      â”‚
â”‚                        offline_access                           â”‚
â”‚                &response_mode=query                             â”‚
â”‚                                                                 â”‚
â”‚  ì½”ë“œ: UserAuthenticationService.GetAuthorizationUrl()         â”‚
â”‚                                                                 â”‚
â”‚  ë°˜í™˜: ë¡œê·¸ì¸ URL (ì‚¬ìš©ìê°€ í´ë¦­)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ ì‚¬ìš©ìê°€ URL í´ë¦­
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  Step 2: Microsoft ë¡œê·¸ì¸ í˜ì´ì§€ (Microsoft Entra)             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  1. ì‚¬ìš©ì ì´ë©”ì¼ ì…ë ¥                                          â”‚
â”‚  2. ë¹„ë°€ë²ˆí˜¸ ì…ë ¥                                              â”‚
â”‚  3. ë‹¤ì¤‘ ì¸ì¦ (í•„ìš” ì‹œ)                                        â”‚
â”‚                                                                 â”‚
â”‚  Microsoftì—ì„œ ì‚¬ìš©ì ì¸ì¦                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ ì¸ì¦ ì„±ê³µ
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  Step 3: ê¶Œí•œ ë™ì˜ í™”ë©´ (Consent)                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  "MCP OneDrive ì•±ì´ ë‹¤ìŒ ê¶Œí•œì„ ìš”ì²­í•©ë‹ˆë‹¤"                   â”‚
â”‚  â–¡ í”„ë¡œí•„ ì¡°íšŒ (User.Read)                                     â”‚
â”‚  â–¡ ì˜¤í”„ë¼ì¸ ì ‘ê·¼ (offline_access)                              â”‚
â”‚  â–¡ Graph API (.default scope)                                  â”‚
â”‚                                                                 â”‚
â”‚  ì‚¬ìš©ì: "ë™ì˜" ë˜ëŠ” "ê±°ë¶€" ì„ íƒ                               â”‚
â”‚                                                                 â”‚
â”‚  âš ï¸  ê´€ë¦¬ìê°€ ì‚¬ì „ ë™ì˜í•œ ê²½ìš°: ì´ ë‹¨ê³„ ìƒëµ                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ ë™ì˜ ì™„ë£Œ
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  Step 4: ì¸ì¦ ì½”ë“œ ë°˜í™˜ (Redirect)                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  Microsoftì—ì„œ Redirect URIë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸:                      â”‚
â”‚                                                                 â”‚
â”‚  GET https://func-onedrive-download-34ugypgdcsh76.azurewebsites.net
â”‚      /auth/callback?code=M.R3_BAY....                           â”‚
â”‚                     &session_state=abc...                       â”‚
â”‚                     &state={OriginalState}                      â”‚
â”‚                                                                 â”‚
â”‚  ì½”ë“œ ìœ íš¨ ì‹œê°„: 10ë¶„ (1íšŒìš©)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ MCP Serverì˜ auth/callback ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ì²˜ë¦¬
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  Step 5: ì¸ì¦ ì½”ë“œë¥¼ í† í°ìœ¼ë¡œ êµí™˜ (Backend)                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  MCP Serverì—ì„œ:                                               â”‚
â”‚                                                                 â”‚
â”‚  POST https://login.microsoftonline.com/{TenantId}/oauth2/v2.0 â”‚
â”‚      /token                                                     â”‚
â”‚                                                                 â”‚
â”‚  Body: {                                                        â”‚
â”‚    "client_id": "{ClientId}",                                  â”‚
â”‚    "client_secret": "{ClientSecret}",  // ì„œë²„ ë¹„ë°€            â”‚
â”‚    "code": "{AuthorizationCode}",                              â”‚
â”‚    "redirect_uri": "{RedirectUri}",                            â”‚
â”‚    "grant_type": "authorization_code",                         â”‚
â”‚    "scope": "https://graph.microsoft.com/.default offline_access"
â”‚  }                                                              â”‚
â”‚                                                                 â”‚
â”‚  ì½”ë“œ: UserAuthenticationService.GetAccessTokenFromCodeAsync() â”‚
â”‚                                                                 â”‚
â”‚  ì‘ë‹µ: {                                                        â”‚
â”‚    "access_token": "eyJhbGc...",                               â”‚
â”‚    "refresh_token": "0.ARwA...",                               â”‚
â”‚    "expires_in": 3600,                      // 1ì‹œê°„           â”‚
â”‚    "token_type": "Bearer",                                     â”‚
â”‚    "scope": "..."                                              â”‚
â”‚  }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ í† í° ìˆ˜ì‹ 
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  Step 6: í† í° ì €ì¥                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                                 â”‚
â”‚  TokenStorage (In-Memory)ì— ì €ì¥:                              â”‚
â”‚  {                                                              â”‚
â”‚    userId: "user@contoso.com",                                 â”‚
â”‚    accessToken: "eyJhbGc...",     // 1ì‹œê°„ ìœ íš¨               â”‚
â”‚    refreshToken: "0.ARwA...",     // 90ì¼ ìœ íš¨                â”‚
â”‚    expiresAt: 2025-11-18 04:35:18                              â”‚
â”‚  }                                                              â”‚
â”‚                                                                 â”‚
â”‚  ì½”ë“œ: TokenStorage.SaveTokenAsync(userId, token, 3600)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ ì¸ì¦ ì™„ë£Œ
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  Step 7: ì €ì¥ëœ í† í°ìœ¼ë¡œ API í˜¸ì¶œ                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  ì´í›„ OneDrive íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œ:                               â”‚
â”‚                                                                 â”‚
â”‚  1. TokenStorageì—ì„œ accessToken ì¡°íšŒ                           â”‚
â”‚  2. GraphServiceClient ìƒì„±                                    â”‚
â”‚  3. Authorization í—¤ë”ì— Bearer token ì¶”ê°€                     â”‚
â”‚  4. Microsoft Graph API í˜¸ì¶œ                                   â”‚
â”‚                                                                 â”‚
â”‚  ì½”ë“œ: UserAuthenticationService.GetUserGraphClientAsync()     â”‚
â”‚                                                                 â”‚
â”‚  ìš”ì²­: GET https://graph.microsoft.com/v1.0/me/drive/items    â”‚
â”‚        Header: Authorization: Bearer eyJhbGc...                â”‚
â”‚                                                                 â”‚
â”‚  ì‘ë‹µ: { "value": [...] }                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚
          â”œâ”€ ê³„ì† ì‚¬ìš© (í† í° ìœ íš¨) â†’ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          â”‚
          â””â”€ í† í° ë§Œë£Œ ì‹œ
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  í† í° ê°±ì‹  í•„ìš”      â”‚
    â”‚  (í˜„ì¬: ì¬ì¸ì¦ í•„ìš”) â”‚
    â”‚                     â”‚
    â”‚  ê°œì„  ì‚¬í•­:         â”‚
    â”‚  Refresh Token ì‚¬ìš© â”‚
    â”‚  â†’ ì‚¬ìš©ì ì¬ì¸ì¦X  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ” í† í° ì €ì¥ ë° ê´€ë¦¬

#### **TokenStorageì˜ ì—­í• **

```csharp
// TokenInfo êµ¬ì¡°
class TokenInfo {
    string AccessToken;      // Graph API í˜¸ì¶œ ì‹œ ì‚¬ìš©
    string RefreshToken;     // í† í° ê°±ì‹  ì‹œ ì‚¬ìš© (í˜„ì¬ ë¯¸ì‚¬ìš©)
    DateTime ExpiresAt;      // ë§Œë£Œ ì‹œê°„
}

// ë©”ì„œë“œ íë¦„
GetAccessTokenAsync(userId)
â”œâ”€ í† í° ì¡´ì¬ í™•ì¸
â”œâ”€ ë§Œë£Œ ì‹œê°„ í™•ì¸
â”‚  â”œâ”€ ìœ íš¨ â†’ ë°˜í™˜
â”‚  â””â”€ ë§Œë£Œ â†’ ì‚­ì œ í›„ null ë°˜í™˜
â””â”€ í† í° ë¯¸ì¡´ì¬ â†’ null ë°˜í™˜

SaveTokenAsync(userId, token, expiresInSeconds)
â””â”€ í† í° ì €ì¥
   â””â”€ ExpiresAt = DateTime.UtcNow + expiresInSeconds

IsTokenExpiredAsync(userId)
â””â”€ DateTime.UtcNow >= token.ExpiresAt ?
```

### â° í† í° ìƒëª…ì£¼ê¸°

```
ì¸ì¦ ì‹œì                     ë§Œë£Œ ì‹œê°„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚                            â”‚
â”‚ Access Token                â”‚
â”‚ íšë“ (ìœ íš¨ì‹œê°„: 1ì‹œê°„)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â”œâ”€ ê°±ì‹  ê°€ëŠ¥ (90ì¼ ë‚´)
â”‚  â””â”€ Refresh Token ì‚¬ìš©
â”‚     â†’ RefreshAccessTokenAsync() í˜¸ì¶œ
â”‚     â†’ ìƒˆ Access Token íšë“
â”‚
â””â”€ ë§Œë£Œ (90ì¼ ì´ˆê³¼)
   â””â”€ ì‚¬ìš©ì ì¬ì¸ì¦ í•„ìš”
      â†’ GetAuthorizationUrl() í˜¸ì¶œ
      â†’ ë‹¤ì‹œ ë¡œê·¸ì¸
```

### ğŸ”‘ ìŠ¤ì½”í”„ ì„¤ëª…

```csharp
// ìš”ì²­í•˜ëŠ” ê¶Œí•œ ë²”ìœ„
var scopes = [
    "https://graph.microsoft.com/.default",  // ëª¨ë“  Graph API ê¶Œí•œ
    "offline_access"                         // ì˜¤í”„ë¼ì¸ í† í° ê°±ì‹  ê¶Œí•œ
];

// .default scopeì˜ ì˜ë¯¸:
// - ì• í”Œë¦¬ì¼€ì´ì…˜ ë“±ë¡ ì‹œ ì„¤ì •í•œ ëª¨ë“  ê¶Œí•œì„ ìš”ì²­
// - ê´€ë¦¬ì ì‚¬ì „ ë™ì˜ í•„ìš”í•œ ê¶Œí•œ í¬í•¨
// - ì˜ˆ: Mail.Send, Files.ReadWrite.All ë“±

// offline_accessì˜ ì˜ë¯¸:
// - Refresh Token ë°œê¸‰ ìš”ì²­
// - ì‚¬ìš©ì ì¬ì¸ì¦ ì—†ì´ í† í° ê°±ì‹  ê°€ëŠ¥
// - í˜„ì¬ ì½”ë“œ: ì•„ì§ ë¯¸í™œìš© (êµ¬í˜„ ì˜ˆì •)
```

### ğŸ’¡ í˜„ì¬ êµ¬í˜„ ìƒíƒœ

| í•­ëª© | ìƒíƒœ | ì„¤ëª… |
|------|------|------|
| Authorization Code Flow | âœ… êµ¬í˜„ë¨ | ì¸ì¦ URL ìƒì„±, ì½”ë“œ êµí™˜ |
| Access Token | âœ… êµ¬í˜„ë¨ | í† í° ì €ì¥ ë° ì¡°íšŒ |
| Token Expiry Check | âœ… êµ¬í˜„ë¨ | ë§Œë£Œ ì‹œê°„ í™•ì¸ |
| Token Refresh | âŒ ë¯¸êµ¬í˜„ | Refresh Tokenìœ¼ë¡œ ê°±ì‹  |
| Session Management | âœ… êµ¬í˜„ë¨ | ASP.NET Core ì„¸ì…˜ |
| Multiple Users | âœ… ì§€ì› | ConcurrentDictionaryë¡œ ë™ì‹œ ì‚¬ìš©ì ê´€ë¦¬ |
| Distributed Cache | âŒ ë¯¸êµ¬í˜„ | í˜„ì¬: In-Memoryë§Œ ì§€ì› |

### ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

```
âœ… ì•ˆì „í•œ êµ¬í˜„:
â”œâ”€ PKCE (í˜„ì¬ëŠ” ë¹„í™œì„±, ê¶Œì¥)
â”œâ”€ State íŒŒë¼ë¯¸í„° (CSRF ë°©ì§€)
â”œâ”€ HttpOnly Cookie (ì„¸ì…˜ ì¿ í‚¤)
â”œâ”€ Secure Flag (HTTPSë§Œ)
â””â”€ SameSite=Lax (CSRF ë°©ì§€)

âš ï¸ ê°œì„  í•„ìš”:
â”œâ”€ Refresh Token êµ¬í˜„ (ìë™ ê°±ì‹ )
â”œâ”€ Distributed Cache (ë¶„ì‚° í™˜ê²½ ëŒ€ì‘)
â”œâ”€ Token Encryption (ì €ì¥ ì‹œ ì•”í˜¸í™”)
â””â”€ Audit Logging (ê°ì‚¬ ë¡œê·¸)
```

---

## ìš”ì•½

### ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸

1. **OneDriveToolì˜ ì„¤ê³„**
   - HTTPë¥¼ í†µí•œ ê³µê°œ/ê³µìœ  ë§í¬ì—ì„œ ì§ì ‘ ë‹¤ìš´ë¡œë“œ
   - ì‚¬ìš©ì ì¸ì¦ ë° SPO ë¼ì´ì„ ìŠ¤ **ë¶ˆí•„ìš”**
   - ì—ëŸ¬ ë°œìƒ ì›ì¸: Graph API ì§ì ‘ í˜¸ì¶œ ë˜ëŠ” ë¹„ê³µê°œ íŒŒì¼ ì ‘ê·¼

2. **ì‚¬ìš©ì íë¦„**
   - URL â†’ ê²€ì¦ â†’ HTTP ë‹¤ìš´ë¡œë“œ â†’ íŒŒì¼ëª… ì¶”ì¶œ â†’ File Share ì—…ë¡œë“œ â†’ ê²°ê³¼ ë°˜í™˜
   - ê°„ë‹¨í•˜ê³  ë¹ ë¥¸ ì²˜ë¦¬

3. **OAuth ì¸ì¦ íë¦„**
   - Authorization Code Flow (ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ í‘œì¤€)
   - 6ë‹¨ê³„: ë¡œê·¸ì¸ URL â†’ ì¸ì¦ â†’ ê¶Œí•œ ë™ì˜ â†’ ì½”ë“œ ë°˜í™˜ â†’ í† í° êµí™˜ â†’ ì €ì¥

4. **í† í° ê´€ë¦¬**
   - In-Memory TokenStorage: ê°„ë‹¨í•˜ì§€ë§Œ ì¬ì‹œì‘ ì‹œ ì†ì‹¤
   - Refresh Token: ì•„ì§ ë¯¸êµ¬í˜„ (ê°œì„  í•„ìš”)
   - ë‹¨ì¼ í…Œë„ŒíŠ¸ ê¸°ë°˜: TenantId ê³ ì •

### ğŸ” ë‹¤ìŒ ë‹¨ê³„ (ê°œì„  ì œì•ˆ)

1. **ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”**
   - ë” ìƒì„¸í•œ ì—ëŸ¬ ë¡œê¹…
   - ì‚¬ìš©ì ì¹œí™”ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€

2. **í† í° ê´€ë¦¬ ê°œì„ **
   - Refresh Token í™œìš©ìœ¼ë¡œ ìë™ ê°±ì‹ 
   - Distributed Cache (Redis) ë„ì…

3. **ë³´ì•ˆ ê°•í™”**
   - PKCE í™œì„±í™”
   - Token Encryption
   - Rate Limiting

4. **ëª¨ë‹ˆí„°ë§**
   - Application Insightsë¡œ ìƒì„¸ ì¶”ì 
   - í† í° ê°±ì‹  ì‹¤íŒ¨ ì•Œë¦¼
   - ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
