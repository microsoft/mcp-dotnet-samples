<!--
    Azure API Management Policy for Protected Resource Metadata (RFC 9728)
    This policy returns Protected Resource Metadata information for OAuth 2.0 protected resources.
    It provides clients with information about the authorization servers, supported methods, and scopes.
    Note: Authentication is disabled for this endpoint to allow anonymous access.
-->
<policies>
    <inbound>
        <!-- Return Protected Resource Metadata according to RFC 9728 -->
        <return-response>
            <set-status code="200" reason="OK" />
            <set-header name="Content-Type" exists-action="override">
                <value>application/json</value>
            </set-header>
            <set-header name="Cache-Control" exists-action="override">
                <value>public, max-age=3600</value>
            </set-header>
            <set-body>@{
                return JsonConvert.SerializeObject(new {
                    resource = "{{APIMGatewayURL}}/mcp",
                    authorization_endpoint = "https://login.microsoftonline.com/common/oauth2/v2.0/authorize",
                    token_endpoint = "https://login.microsoftonline.com/common/oauth2/v2.0/token",
                    revocation_endpoint = "https://login.microsoftonline.com/common/oauth2/v2.0/revoke",
                    client_id = "{{McpClientId}}",
                    scopes = new[] { "https://graph.microsoft.com/.default", "offline_access" },
                    response_types_supported = new[] { "code" },
                    code_challenge_methods_supported = new[] { "S256" },
                    token_endpoint_auth_methods_supported = new[] { "none" },
                    grant_types_supported = new[] { "authorization_code", "refresh_token" }
                });
            }</set-body>
        </return-response>
    </inbound>
    <backend>
        <base />
    </backend>
    <outbound>
        <base />
    </outbound>
    <on-error>
        <base />
    </on-error>
</policies>